netsuke_version: "1.0"

vars:
  chapters_dir: chapters
  build_dir: build
  pandoc_flags: "-N --pdf-engine=xelatex"

rules:
  - name: tex
    command: "pandoc {{ pandoc_flags }} {ins} -o {outs}"

  - name: combine
    command: "latexmk -pdf -outdir={{ build_dir }} {ins}"

macros:
  - signature: "chapter(path)"
    body: |
      - name: "{{ build_dir }}/{{ path | basename | replace('.md', '.tex') }}"
        rule: tex
        sources: "{{ path }}"

targets:
  - foreach: "{{ glob(chapters_dir ~ '/*.md') }}"
    {{ chapter(item) }}

  - name: "{{ build_dir }}/book.pdf"
    rule: combine
    sources: "{{ glob(build_dir ~ '/*.tex') }}"

defaults:
  - "{{ build_dir }}/book.pdf"
