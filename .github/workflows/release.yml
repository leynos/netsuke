---
name: Release Binary

'on':
  push:
    tags:
      - 'v*.*.*'
  workflow_call:
    inputs:
      publish:
        description: >-
          Whether the workflow should publish artefacts to the GitHub release
          associated with the tag. Defaults to `false` when invoked as a
          reusable workflow.
        required: false
        type: boolean
        default: false
      dry-run:
        description: >-
          When `true`, build artefacts without uploading them to GitHub
          releases or workflow artefacts.
        required: false
        type: boolean
        default: false
      wix-extension-version:
        description: >-
          Version of the WixToolset.UI.wixext extension to install alongside
          the WiX CLI.
        required: false
        type: string
        default: '6'
    outputs:
      bin_name:
        description: Binary name extracted from Cargo.toml
        value: ${{ jobs.metadata.outputs.bin_name }}
      version:
        description: Crate version resolved from Cargo.toml
        value: ${{ jobs.metadata.outputs.version }}
      should_publish:
        description: Whether artefacts should be published to the release
        value: ${{ jobs.metadata.outputs.should_publish }}
      dry_run:
        description: Whether the workflow is running in dry-run mode
        value: ${{ jobs.metadata.outputs.dry_run }}
      should_upload_workflow_artifacts:
        description: Whether workflow artefact uploads are enabled
        value: ${{ jobs.metadata.outputs.should_upload_workflow_artifacts }}
      wix_extension_version:
        description: >-
          Resolved WixToolset.UI.wixext version compatible with the configured
          WiX CLI toolchain
        value: ${{ jobs.metadata.outputs.wix_extension_version }}

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ensure_version.outputs['crate-version'] }}
      bin_name: ${{ steps.bin_name.outputs.value }}
      should_publish: ${{ steps.release_modes.outputs.should_publish }}
      dry_run: ${{ steps.release_modes.outputs.dry_run }}
      should_upload_workflow_artifacts: ${{ steps.release_modes.outputs.should_upload_workflow_artifacts }}
      wix_extension_version: ${{ steps.wix_extension_version.outputs.value }}
      repo_name: ${{ steps.repo_name.outputs.value }}
    steps:
      - uses: >-
          actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633
        # v4.1.2
      - id: repo_name
        name: Determine repository name
        run: echo "value=${GITHUB_REPOSITORY#*/}" >>"$GITHUB_OUTPUT"
      - name: Setup Python 3.11
        uses: >-
          actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        # v5
        with:
          python-version: '3.11'
      - id: release_modes
        name: Determine release modes
        run: python3 .github/workflows/scripts/determine_release_modes.py
      - id: ensure_version
        name: Read package version from Cargo.toml
        uses: >-
          leynos/shared-actions/.github/actions/ensure-cargo-version@dd56f18c39f1e158eb04cd5b4fc9194aadb6b52b
        with:
          check-tag: ${{ fromJSON(steps.release_modes.outputs.should_publish) }}
      - id: wix_extension_version
        name: Resolve WiX extension version
        shell: bash
        run: |
          set -euo pipefail
          version=''
          if [ "${{ github.event_name }}" = 'workflow_call' ]; then
            version="$(jq -r '.inputs["wix-extension-version"] // empty' \
              "$GITHUB_EVENT_PATH")"
          fi
          if [ -z "$version" ] || [ "$version" = 'null' ]; then
            version='6'
          fi
          echo "value=$version" >>"$GITHUB_OUTPUT"
      - id: bin_name
        name: Extract binary name from Cargo.toml
        shell: bash
        run: |
          set -euo pipefail
          manifest_path="${CARGO_TOML_PATH:-Cargo.toml}"
          name="$(python3 .github/workflows/scripts/read_manifest.py \
            --manifest-path "$manifest_path" name 2>/tmp/name.err)"
          if [ -z "$name" ]; then
            message='::error title=Cargo.toml parse failure::Could not read '
            message+='package.name from '
            message+="${manifest_path}."
            echo "$message"
            cat /tmp/name.err >&2 || true
            exit 1
          fi
          echo "value=$name" >>"$GITHUB_OUTPUT"

  build-linux:
    needs: metadata
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            artifact: linux-amd64
            package_arch: amd64
          - target: aarch64-unknown-linux-gnu
            artifact: linux-arm64
            package_arch: arm64
    uses: ./.github/workflows/build-and-package.yml
    with:
      platform: linux
      runner: ubuntu-latest
      target: ${{ matrix.target }}
      bin-name: ${{ needs.metadata.outputs.bin_name }}
      version: ${{ needs.metadata.outputs.version }}
      artifact-name: ${{ needs.metadata.outputs.repo_name }}-${{ matrix.artifact }}
      should-upload-workflow-artifacts: ${{ fromJSON(needs.metadata.outputs.should_upload_workflow_artifacts) }}
      package-arch: ${{ matrix.package_arch }}

  build-windows:
    needs: metadata
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            package_arch: amd64
            msi_arch: x64
            target_key: windows-x86_64
          - target: aarch64-pc-windows-msvc
            package_arch: arm64
            msi_arch: arm64
            target_key: windows-aarch64
    uses: ./.github/workflows/build-and-package.yml
    with:
      platform: windows
      runner: windows-latest
      target: ${{ matrix.target }}
      bin-name: ${{ needs.metadata.outputs.bin_name }}
      version: ${{ needs.metadata.outputs.version }}
      artifact-name: ${{ needs.metadata.outputs.repo_name }}-windows-${{ matrix.package_arch }}
      should-upload-workflow-artifacts: ${{ fromJSON(needs.metadata.outputs.should_upload_workflow_artifacts) }}
      stage-target: ${{ matrix.target_key }}
      msi-arch: ${{ matrix.msi_arch }}
      wix-extension-version: ${{ needs.metadata.outputs.wix_extension_version }}

  build-macos:
    needs: metadata
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            runner: macos-13
            artifact_suffix: macos-x86_64
            target_key: macos-x86_64
          - target: aarch64-apple-darwin
            runner: macos-14
            artifact_suffix: macos-arm64
            target_key: macos-aarch64
    uses: ./.github/workflows/build-and-package.yml
    with:
      platform: macos
      runner: ${{ matrix.runner }}
      target: ${{ matrix.target }}
      bin-name: ${{ needs.metadata.outputs.bin_name }}
      version: ${{ needs.metadata.outputs.version }}
      artifact-name: ${{ needs.metadata.outputs.repo_name }}-${{ matrix.artifact_suffix }}
      should-upload-workflow-artifacts: ${{ fromJSON(needs.metadata.outputs.should_upload_workflow_artifacts) }}
      stage-target: ${{ matrix.target_key }}
      artifact-suffix: ${{ matrix.artifact_suffix }}

  release:
    if: needs.metadata.outputs.should_publish == 'true'
    permissions:
      contents: write
    needs:
      - metadata
      - build-linux
      - build-windows
      - build-macos
    runs-on: ubuntu-latest
    steps:
      - uses: >-
          actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633
        # v4.1.2
      - name: Ensure release exists (draft)
        shell: bash
        run: |
          set -euo pipefail
          gh release view "${{ github.ref_name }}" >/dev/null 2>&1 || \
            gh release create "${{ github.ref_name }}" \
              --draft \
              --verify-tag \
              --notes "Automated release for ${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: >-
          actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        # v4
        with:
          path: dist
          pattern: ${{ needs.metadata.outputs.repo_name }}-*
      - id: upload_assets
        name: Upload artefacts to release
        uses: ./.github/actions/upload-release-assets
        with:
          release-tag: ${{ github.ref_name }}
          bin-name: ${{ needs.metadata.outputs.bin_name }}
          dist-dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Check asset upload errors
        if: steps.upload_assets.outputs.upload-error == 'true'
        run: |
          echo "Error uploading release assets:"
          printf '%s\n' "${{ steps.upload_assets.outputs.error-message }}"
          exit 1
